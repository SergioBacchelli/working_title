# BXF2: правила формирования и координаты (по примеру Novyj-korpus.bxf2)
Документ фиксирует **то, что реально видно в файле** `Novyj-korpus.bxf2`, и превращает это в набор правил, по которым дальше будем генерировать корректный BXF2.
> Важно: в этом конкретном файле **нет отверстий/пазов** (разделы `machiningGroups` и `machinings` пустые). Поэтому ниже мы фиксируем **место в структуре**, **систему координат** и **правила для панелей**. Для правил отверстий/пазов понадобится второй пример BXF2, где они реально присутствуют.
## 1) Что лежит в файле
- Формат: XML, namespace `http://www.blum.com/bxf2`.
- Версия BXF2 в заголовке: `2.3`.
- Единицы: миллиметры (`unit name="mm" meter="0.001"`), углы в градусах (`angularUnit=degree`).
- Структура верхнего уровня:
  - `head` — метаданные/единицы.
  - `scene` — размещение «узлов» (кабинетов) в сцене.
  - `library` — библиотека объектов: `cabinets`, `parts`, (и потенциально `machinings`).
## 2) Координатные системы
### 2.1 Глобальная система координат (кабинет/сцена)
По рассчитанным bounding-box всех деталей из файла (см. ниже) получаем стабильную интерпретацию осей:
- **X**: слева → направо (ширина корпуса).
- **Y**: снизу → вверх (высота корпуса).
- **Z**: сзади → вперед (глубина к фасаду).

Точка `(0,0,0)` — **левый-нижний-задний внешний угол корпуса**.
В этом файле корпус занимает:
- X: `0 … 600`
- Y: `0 … 360`
- Z: `0 … 310`
### 2.2 Локальная система координат детали (part)
Каждая панель описана как `geometry` типа `Box` с элементом `extent`.
Правило из файла:
- `extent = (Ex, Ey, Ez)` — это **вектор до противоположного угла коробки** от локального `(0,0,0)`.
- Модуль значений: `|Ex|, |Ey|, |Ez|` соответствуют **длина, ширина, толщина**.
- Знак (`+/-`) задаёт, в какую сторону по оси «растёт» коробка, т.е. **какой угол панели выбран как локальный (0,0,0)**.

Удобная для нас интерпретация локальных осей панели (совпадает с этим файлом):
- локальная **X** = «длина» панели
- локальная **Y** = «ширина» панели
- локальная **Z** = «толщина» панели
## 3) Как в BXF2 записана панель
Панель хранится в `library/parts/part`:
- `part @id` — идентификатор
- `description` — имя
- `geometry xsi:type="Box"` + `extent` — размеры (и ориентация/выбор угла)
- `drawingDetail frontOrientation / floorOrientation` — ориентации для чертежа (в этом файле заданы векторами)
- `material` — материал (здесь `WoodMaterial name="wood"`)
## 4) Как панель позиционируется в корпусе
Размещение идёт через `library/cabinets/cabinet/partLinks/partLink`:
- `partLink @referenceId` → ссылка на `parts/part @id`
- `transformations/transformation` — список операций.

**Ключевое правило (как видно в файле):**
- `rotation="ax ay az angle"` — поворот вокруг оси (axis-angle), угол в градусах.
- `translation="tx ty tz"` — перенос.
- Операции применяются **последовательно в порядке записи**.

Для проверки мы просчитали итоговые bounding-box (см. таблицу ниже) — все детали встают строго в ожидаемый корпус.
## 5) Разобранный пример: Novyj-korpus.bxf2
### 5.1 Панели (library/parts)
| Part ID | Имя | extent (как в файле) | Размеры (мм) |
|---|---|---:|---:|
| `ID00002` | Крышка корпуса | `-568.0 310.0 16.0` | `568 × 310 × 16` |
| `ID00004` | Дно корпуса | `568.0 310.0 16.0` | `568 × 310 × 16` |
| `ID00006` | Боковина, левая | `-360.0 310.0 16.0` | `360 × 310 × 16` |
| `ID00008` | Боковина, правая | `360.0 310.0 16.0` | `360 × 310 × 16` |
| `ID00010` | Фасад | `596.0 356.0 18.0` | `596 × 356 × 18` |

> Нюанс: в файле **Фасад имеет толщину 18 мм** (extent `596 356 18`). Это отличается от списка, который ты написал (16 мм).
### 5.2 Размещение (library/cabinets → partLinks)
| Деталь | referenceId | Операции (в порядке) | Итоговый bbox в координатах корпуса (min → max) |
|---|---|---|---|
| Крышка корпуса | `ID00002` | R(1,0,0; -90°) → R(0,0,1; 180°) → T(16,360,310) | `(16,344,0) → (584,360,310)` |
| Дно корпуса | `ID00004` | R(1,0,0; -90°) → T(16,0,310) | `(16,0,0) → (584,16,310)` |
| Боковина, левая | `ID00006` | R(1,0,0; -90°) → R(0,0,1; -90°) → T(0,0,310) | `(-2.20436e-14,0,0) → (16,360,310)` |
| Боковина, правая | `ID00008` | R(1,0,0; -90°) → R(0,0,1; 90°) → T(600,0,310) | `(584,0,0) → (600,360,310)` |
| A/1 Фасад | `ID00010` | R(0,1,0; 180°) → T(598,2,328) | `(2,2,310) → (598,358,328)` |

Из bbox хорошо видно «геометрию корпуса»:
- Толщина боковин = 16 → левая занимает X `0…16`, правая X `584…600`.
- Внутренняя ширина = `584 - 16 = 568`.
- Низ Y `0…16`, верх Y `344…360`.
- Глубина корпуса Z `0…310`.
- Фасад стоит **перед корпусом**: Z `310…328`, и имеет зазоры по 2 мм слева/справа/сверху/снизу.
## 6) Правила, которые фиксируем для генератора BXF2
Это — «контракт» между нашими логическими модулями (которые считают детали) и будущим экспортом в BXF2.
### 6.1 Наш внутренний формат (минимально достаточный)
Для каждой панели нам достаточно хранить:
- `name`
- `size` = `{L, W, T}` (мм)
- `localOriginCorner` — какой угол панели считаем `(0,0,0)` (чтобы потом правильно вычислять координаты отверстий/пазов)
- `transform` относительно корпуса:
  - `rotations[]` в axis-angle (как в BXF2)
  - `translation` (X,Y,Z) в мм
- `bbox` (опционально, но очень полезно для валидации)

Пример (в стиле JSON) для дна из этого файла:
```json
{
  "name": "Дно корпуса",
  "size": {"L": 568, "W": 310, "T": 16},
  "localOriginCorner": "front-left-bottom",
  "transform": {
    "rotations": [ {"axis": [1,0,0], "deg": -90} ],
    "translation": [16, 0, 310]
  }
}
```
### 6.2 Правила записи панели в BXF2
1) На каждую физическую панель создаём отдельный `library/parts/part`.
2) `geometry` делаем `xsi:type="Box"`.
3) `extent` задаём как `Ex Ey Ez`:
   - `|Ex|=L`, `|Ey|=W`, `|Ez|=T`
   - знак выбираем так, чтобы локальный `(0,0,0)` был **тем углом**, от которого нам проще задавать отверстия/пазы.
4) Позиционирование панели — только через `partLink/transformations`.
5) Порядок операций — важен. Конвенция, которую принимаем:
   - сначала `rotation` (1..N)
   - затем `translation` (ровно 1)
   Это совпадает с примером файла.
### 6.3 Валидация (чтобы не ловить «невидимый хаос»)
Для каждой панели после сборки трансформаций считаем bbox и проверяем:
- боковины имеют толщину по X и стоят на X=0 и X=OuterWidth
- верх/низ имеют толщину по Y
- глубина корпуса по Z согласована
- фасад/фурнитура стоят «перед» корпусом (если нужно)

Если bbox не проходит — значит ошибка в знаках `extent`, порядке rotation, или в translation.
## 7) Отверстия и пазы: что пока можем зафиксировать
В файле есть пустые контейнеры `machiningGroups` и `machinings`, т.е. **формально место под обработки предусмотрено**, но данных нет.
Что фиксируем уже сейчас (без фантазий про конкретные теги):
- Мы будем описывать обработки как отдельные сущности (drilling / groove / pocket ...), которые:
  1) привязаны к **конкретной панели** (по `part id` или через link),
  2) заданы в **локальных координатах панели** (это критично),
  3) имеют параметрику: позиция, направление, диаметр/ширина, глубина, сквозное/глухое.

**Нужный следующий шаг:** взять пример BXF2, в котором есть хотя бы 1–2 сверления и 1 паз, и точно зафиксировать:
- где эти элементы лежат в XML (какие теги и связи)
- в каких координатах (локаль панели или глобаль корпуса)
- как задаётся ориентация (нормаль/ось), глубина и тип операции
## 8) Примечание про смысл BXF/BXF2
Blum описывает BXF как формат обмена, который содержит не только информацию о фурнитуре, но и производственные данные по деревянным деталям (в т.ч. размеры/сверления).
